description: Configure SSH host key settings for telemetry collection
parameters:
  targets:
    type: TargetSpec
    description: A list of targets to apply this plan on

  ssh_config_content:
    type: String
    default: |
      Host *
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null

steps:
  - name: all_targets
    eval: get_targets($targets)

  - name: apply_prep_step
    command: apply_prep
    targets: $all_targets

  - name: apply_resources
    eval: |
      apply($all_targets) {
        # Ensure .ssh directory exists
        file { "${::home}/.ssh":
          ensure  => directory,
          owner   => $::user,
          group   => $::group,
          mode    => '0700',
        }

        # SSH config file
        file { "${::home}/.ssh/config":
          ensure  => file,
          owner   => $::user,
          group   => $::group,
          mode    => '0600',
          content => $ssh_config_content,
        }
      }

  - name: notify_ssh_config
    message: "SSH Configuration Applied Successfully!"
    #level: notice
    targets: $all_targets

return: $notify_ssh_config
